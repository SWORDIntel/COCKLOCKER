<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intel Hardware Monitor - CockLocker</title>
    <link href="../base1/cockpit.css" rel="stylesheet" type="text/css">
    <style>
        :root {
            --intel-blue: #0071c5;
            --intel-dark: #1a1a2e;
            --success-green: #28a745;
            --warning-yellow: #ffc107;
            --danger-red: #dc3545;
        }

        .intel-monitor-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-banner {
            background: linear-gradient(135deg, var(--intel-blue), #004a8f);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .header-banner h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .header-banner .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .metric-card h3 {
            margin: 0 0 15px 0;
            color: var(--intel-dark);
            font-size: 16px;
            border-bottom: 2px solid var(--intel-blue);
            padding-bottom: 10px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--intel-blue);
        }

        .metric-unit {
            font-size: 14px;
            color: #666;
            margin-left: 5px;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-green { background: var(--success-green); }
        .progress-yellow { background: var(--warning-yellow); }
        .progress-red { background: var(--danger-red); }
        .progress-blue { background: var(--intel-blue); }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active { background: var(--success-green); }
        .status-warning { background: var(--warning-yellow); }
        .status-error { background: var(--danger-red); }
        .status-inactive { background: #999; }

        .core-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .core-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .core-item.p-core { border-left: 3px solid var(--intel-blue); }
        .core-item.e-core { border-left: 3px solid var(--success-green); }

        .core-freq {
            font-size: 12px;
            color: #666;
        }

        .power-control {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .power-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .power-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .power-btn.performance {
            background: var(--danger-red);
            color: white;
        }

        .power-btn.balanced {
            background: var(--intel-blue);
            color: white;
        }

        .power-btn.powersave {
            background: var(--success-green);
            color: white;
        }

        .power-btn.active {
            outline: 3px solid #333;
            outline-offset: 2px;
        }

        .npu-section {
            background: linear-gradient(135deg, #1a1a2e, #2d2d44);
            color: white;
            border-radius: 8px;
            padding: 20px;
        }

        .npu-section h3 {
            color: white;
            border-bottom-color: rgba(255,255,255,0.3);
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .feature-list li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .feature-list li:last-child {
            border-bottom: none;
        }

        .refresh-btn {
            float: right;
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="intel-monitor-container">
        <div class="header-banner">
            <h1>Intel Hardware Monitor</h1>
            <p class="subtitle">Real-time monitoring for Intel Meteor Lake processors with AI power management</p>
            <button class="refresh-btn" onclick="refreshAll()">⟳ Refresh</button>
        </div>

        <div class="metrics-grid">
            <!-- CPU Overview -->
            <div class="metric-card">
                <h3>CPU Overview</h3>
                <div id="cpu-name">Loading...</div>
                <div class="metric-value" id="cpu-freq">--</div>
                <div class="metric-label">Current Frequency (GHz)</div>
                <div class="progress-bar">
                    <div class="progress-bar-fill progress-blue" id="cpu-freq-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- CPU Temperature -->
            <div class="metric-card">
                <h3>CPU Temperature</h3>
                <div class="metric-value" id="cpu-temp">--</div>
                <span class="metric-unit">°C</span>
                <div class="metric-label">Package Temperature</div>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="temp-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Power Consumption -->
            <div class="metric-card">
                <h3>Power Consumption</h3>
                <div class="metric-value" id="power-usage">--</div>
                <span class="metric-unit">W</span>
                <div class="metric-label">Package Power (RAPL)</div>
                <div class="progress-bar">
                    <div class="progress-bar-fill progress-yellow" id="power-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Hybrid Cores -->
            <div class="metric-card">
                <h3>Hybrid Architecture</h3>
                <div>
                    <span class="status-indicator" id="hybrid-status"></span>
                    <span id="hybrid-text">Checking...</span>
                </div>
                <div class="core-grid" id="core-grid">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- NPU Status -->
            <div class="metric-card npu-section">
                <h3>Neural Processing Unit (NPU)</h3>
                <div>
                    <span class="status-indicator" id="npu-status"></span>
                    <span id="npu-text">Checking...</span>
                </div>
                <ul class="feature-list" style="color: white; margin-top: 15px;">
                    <li><span>NPU Driver</span><span id="npu-driver">--</span></li>
                    <li><span>Power Mode</span><span id="npu-power">--</span></li>
                    <li><span>Temperature</span><span id="npu-temp">--</span></li>
                </ul>
            </div>

            <!-- CPU Features -->
            <div class="metric-card">
                <h3>CPU Features</h3>
                <ul class="feature-list" id="cpu-features">
                    <li><span>AVX2</span><span id="feat-avx2">--</span></li>
                    <li><span>AVX-512</span><span id="feat-avx512">--</span></li>
                    <li><span>AVX-VNNI</span><span id="feat-avxvnni">--</span></li>
                    <li><span>AMX</span><span id="feat-amx">--</span></li>
                    <li><span>Intel CET</span><span id="feat-cet">--</span></li>
                </ul>
            </div>

            <!-- Power Profile -->
            <div class="metric-card">
                <h3>Power Profile</h3>
                <div class="metric-label">Select power profile for AI workloads:</div>
                <div class="power-control">
                    <button class="power-btn performance" onclick="setPowerProfile('performance')">
                        Performance
                    </button>
                    <button class="power-btn balanced active" onclick="setPowerProfile('balanced')">
                        Balanced
                    </button>
                    <button class="power-btn powersave" onclick="setPowerProfile('powersave')">
                        Power Save
                    </button>
                </div>
                <div class="metric-label" style="margin-top: 15px;">
                    Current: <strong id="current-profile">balanced</strong>
                </div>
            </div>

            <!-- RAPL Domains -->
            <div class="metric-card">
                <h3>RAPL Power Domains</h3>
                <ul class="feature-list" id="rapl-domains">
                    <li><span>Package</span><span id="rapl-pkg">--</span></li>
                    <li><span>Core</span><span id="rapl-core">--</span></li>
                    <li><span>Uncore</span><span id="rapl-uncore">--</span></li>
                    <li><span>DRAM</span><span id="rapl-dram">--</span></li>
                </ul>
            </div>
        </div>
    </div>

    <script src="../base1/cockpit.js"></script>
    <script>
        // Initialize Cockpit
        cockpit.transport.wait(function() {
            refreshAll();
            // Auto-refresh every 2 seconds
            setInterval(refreshAll, 2000);
        });

        function refreshAll() {
            getCPUInfo();
            getCPUTemperature();
            getPowerUsage();
            getHybridCores();
            getNPUStatus();
            getCPUFeatures();
            getRAPLDomains();
        }

        function getCPUInfo() {
            cockpit.spawn(["cat", "/proc/cpuinfo"])
                .then(function(data) {
                    const lines = data.split('\n');
                    let cpuName = '';
                    let freq = 0;

                    for (const line of lines) {
                        if (line.startsWith('model name')) {
                            cpuName = line.split(':')[1].trim();
                        }
                        if (line.startsWith('cpu MHz')) {
                            freq = parseFloat(line.split(':')[1].trim());
                        }
                    }

                    document.getElementById('cpu-name').textContent = cpuName;
                    document.getElementById('cpu-freq').textContent = (freq / 1000).toFixed(2);

                    // Assume max freq of 5GHz for bar
                    const freqPercent = Math.min((freq / 5000) * 100, 100);
                    document.getElementById('cpu-freq-bar').style.width = freqPercent + '%';
                })
                .catch(console.error);
        }

        function getCPUTemperature() {
            cockpit.spawn(["cat", "/sys/class/thermal/thermal_zone0/temp"])
                .then(function(data) {
                    const temp = parseInt(data) / 1000;
                    document.getElementById('cpu-temp').textContent = temp.toFixed(0);

                    const tempBar = document.getElementById('temp-bar');
                    const tempPercent = Math.min((temp / 100) * 100, 100);
                    tempBar.style.width = tempPercent + '%';

                    // Color based on temperature
                    if (temp < 60) {
                        tempBar.className = 'progress-bar-fill progress-green';
                    } else if (temp < 80) {
                        tempBar.className = 'progress-bar-fill progress-yellow';
                    } else {
                        tempBar.className = 'progress-bar-fill progress-red';
                    }
                })
                .catch(function() {
                    document.getElementById('cpu-temp').textContent = 'N/A';
                });
        }

        function getPowerUsage() {
            cockpit.spawn(["cat", "/sys/class/powercap/intel-rapl/intel-rapl:0/energy_uj"])
                .then(function(data) {
                    // This is cumulative energy, need to calculate power over time
                    const energy = parseInt(data);
                    // For now, show a placeholder
                    document.getElementById('power-usage').textContent = '--';
                })
                .catch(function() {
                    document.getElementById('power-usage').textContent = 'N/A';
                });
        }

        function getHybridCores() {
            cockpit.spawn(["nproc"])
                .then(function(data) {
                    const totalCores = parseInt(data);
                    const coreGrid = document.getElementById('core-grid');
                    coreGrid.innerHTML = '';

                    // Estimate P-cores and E-cores (typical Meteor Lake config)
                    // This is simplified - real detection would check core_type
                    const pCores = Math.ceil(totalCores * 0.4);
                    const eCores = totalCores - pCores;

                    for (let i = 0; i < totalCores; i++) {
                        const coreDiv = document.createElement('div');
                        coreDiv.className = 'core-item ' + (i < pCores ? 'p-core' : 'e-core');
                        coreDiv.innerHTML = `
                            <div><strong>${i < pCores ? 'P' : 'E'}${i}</strong></div>
                            <div class="core-freq">--</div>
                        `;
                        coreGrid.appendChild(coreDiv);
                    }

                    document.getElementById('hybrid-status').className = 'status-indicator status-active';
                    document.getElementById('hybrid-text').textContent =
                        `${pCores} P-cores + ${eCores} E-cores`;
                })
                .catch(console.error);
        }

        function getNPUStatus() {
            cockpit.spawn(["ls", "/sys/class/accel/"])
                .then(function(data) {
                    if (data.trim()) {
                        document.getElementById('npu-status').className = 'status-indicator status-active';
                        document.getElementById('npu-text').textContent = 'Available';
                        document.getElementById('npu-driver').textContent = 'Loaded';
                        document.getElementById('npu-power').textContent = 'Auto';
                    } else {
                        throw new Error('No NPU');
                    }
                })
                .catch(function() {
                    document.getElementById('npu-status').className = 'status-indicator status-inactive';
                    document.getElementById('npu-text').textContent = 'Not Detected';
                    document.getElementById('npu-driver').textContent = 'N/A';
                    document.getElementById('npu-power').textContent = 'N/A';
                });
        }

        function getCPUFeatures() {
            cockpit.spawn(["cat", "/proc/cpuinfo"])
                .then(function(data) {
                    const flags = data.match(/flags\s*:\s*(.+)/);
                    if (flags) {
                        const flagList = flags[1];

                        document.getElementById('feat-avx2').textContent =
                            flagList.includes('avx2') ? '✓' : '✗';
                        document.getElementById('feat-avx512').textContent =
                            flagList.includes('avx512') ? '✓' : '✗';
                        document.getElementById('feat-avxvnni').textContent =
                            flagList.includes('avx_vnni') ? '✓' : '✗';
                        document.getElementById('feat-amx').textContent =
                            flagList.includes('amx_tile') ? '✓' : '✗';
                        document.getElementById('feat-cet').textContent =
                            (flagList.includes('shstk') || flagList.includes('ibt')) ? '✓' : '✗';
                    }
                })
                .catch(console.error);
        }

        function getRAPLDomains() {
            const domains = ['pkg', 'core', 'uncore', 'dram'];
            domains.forEach(function(domain, idx) {
                document.getElementById('rapl-' + domain).textContent = 'Available';
            });
        }

        function setPowerProfile(profile) {
            cockpit.spawn(["/opt/cockpit-hardened/intel/meteorlake_optimizer.sh",
                          "set_meteorlake_power_profile", profile], { superuser: "try" })
                .then(function() {
                    // Update UI
                    document.querySelectorAll('.power-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    event.target.classList.add('active');
                    document.getElementById('current-profile').textContent = profile;
                })
                .catch(function(err) {
                    console.error("Failed to set power profile:", err);
                    alert("Failed to set power profile. May require root privileges.");
                });
        }
    </script>
</body>
</html>
